<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pelayanan Dukcapil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">


    <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8">
        <!-- Filter Cerdas -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8 border border-gray-100">
            <div class="mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2">Filter & Kontrol Data</h3>
                <p class="text-sm sm:text-base text-gray-600">Kelola tampilan data berdasarkan kategori dan periode waktu</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Filter Kategori -->
                <div class="space-y-3 md:col-span-2 lg:col-span-1">
                    <label class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <i class="fas fa-filter text-blue-600"></i>
                        <span>Filter Kategori</span>
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button id="filterAll" class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:bg-blue-700 transition-all duration-200 shadow-sm flex items-center justify-center">
                            <i class="fas fa-th-large mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                            <span class="truncate">Semua</span>
                        </button>
                        <button id="filterKependudukan" class="px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:bg-gray-200 transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-id-card mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                            <span class="truncate">Kependudukan</span>
                        </button>
                        <button id="filterSipil" class="px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:bg-gray-200 transition-all duration-200 flex items-center justify-center">
                            <i class="fas fa-certificate mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                            <span class="truncate">Pencatatan Sipil</span>
                        </button>
                    </div>
                </div>

                <!-- Filter Tanggal -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <i class="fas fa-calendar-alt text-green-600"></i>
                        <span>Filter Tanggal</span>
                    </label>
                    <div class="flex flex-col space-y-2">
                        <select id="dateFilter" class="border border-gray-300 rounded-lg sm:rounded-xl px-3 sm:px-4 py-2 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm">
                            <option value="today">Hari Ini</option>
                            <option value="yesterday">Kemarin</option>
                            <option value="week">7 Hari Terakhir</option>
                            <option value="month">30 Hari Terakhir</option>
                            <option value="custom">Pilih Tanggal</option>
                        </select>
                        <div id="customDateRange" class="hidden flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <input type="date" id="startDate" class="border border-gray-300 rounded-lg px-3 py-2 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-green-500 flex-1">
                            <input type="date" id="endDate" class="border border-gray-300 rounded-lg px-3 py-2 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-green-500 flex-1">
                        </div>
                    </div>
                </div>

                <!-- Kontrol Aksi -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <i class="fas fa-cogs text-purple-600"></i>
                        <span>Kontrol Aksi</span>
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button id="refreshData" class="px-3 sm:px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200 flex items-center justify-center space-x-1 sm:space-x-2 shadow-sm">
                            <i class="fas fa-sync-alt text-xs sm:text-sm"></i>
                            <span class="truncate">Refresh Data</span>
                        </button>
                        <button id="exportData" class="px-3 sm:px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:from-purple-700 hover:to-purple-800 transition-all duration-200 flex items-center justify-center space-x-1 sm:space-x-2 shadow-sm">
                            <i class="fas fa-download text-xs sm:text-sm"></i>
                            <span class="truncate">Export Data</span>
                        </button>
                        <button id="inputProgress" class="px-3 sm:px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-700 text-white rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:from-orange-700 hover:to-orange-800 transition-all duration-200 flex items-center justify-center space-x-1 sm:space-x-2 shadow-sm">
                            <i class="fas fa-plus-circle text-xs sm:text-sm"></i>
                            <span class="truncate">Input Progres</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Koneksi -->
            <div class="mt-4 sm:mt-6 pt-4 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0">
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full pulse-animation"></div>
                            <span class="text-xs sm:text-sm font-medium text-green-700">Terhubung ke Google Sheets</span>
                        </div>
                        <div class="hidden sm:block text-sm text-gray-500">|</div>
                        <div class="text-xs sm:text-sm text-gray-600">
                            <span id="dataCount">0</span> record tersedia
                        </div>
                    </div>
                    <div class="text-xs sm:text-sm text-gray-500">
                        Sinkronisasi otomatis setiap 30 detik
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <div class="bg-white rounded-lg sm:rounded-xl shadow-md p-4 sm:p-6 card-hover border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-600 text-xs sm:text-sm font-medium truncate">Total Dokumen Hari Ini</p>
                        <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="totalToday">0</p>
                    </div>
                    <div class="bg-blue-100 p-2 sm:p-3 rounded-full flex-shrink-0 ml-3">
                        <i class="fas fa-file-alt text-blue-600 text-lg sm:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg sm:rounded-xl shadow-md p-4 sm:p-6 card-hover border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-600 text-xs sm:text-sm font-medium truncate">Dokumen Kependudukan</p>
                        <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="totalKependudukan">0</p>
                    </div>
                    <div class="bg-green-100 p-2 sm:p-3 rounded-full flex-shrink-0 ml-3">
                        <i class="fas fa-id-card text-green-600 text-lg sm:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg sm:rounded-xl shadow-md p-4 sm:p-6 card-hover border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-600 text-xs sm:text-sm font-medium truncate">Pencatatan Sipil</p>
                        <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="totalSipil">0</p>
                    </div>
                    <div class="bg-purple-100 p-2 sm:p-3 rounded-full flex-shrink-0 ml-3">
                        <i class="fas fa-certificate text-purple-600 text-lg sm:text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg sm:rounded-xl shadow-md p-4 sm:p-6 card-hover border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-600 text-xs sm:text-sm font-medium truncate">Stok Blangko KTP-el</p>
                        <p class="text-2xl sm:text-3xl font-bold text-gray-800" id="stokBlangko">0</p>
                    </div>
                    <div class="bg-orange-100 p-2 sm:p-3 rounded-full flex-shrink-0 ml-3">
                        <i class="fas fa-warehouse text-orange-600 text-lg sm:text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 sm:gap-8">
            <!-- Dokumen Kependudukan -->
            <div class="xl:col-span-3">
                <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 border border-gray-100">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-8">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">Dokumen Kependudukan</h2>
                            <p class="text-sm sm:text-base text-gray-600">Monitoring real-time penerbitan dokumen identitas</p>
                        </div>
                        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
                            <div class="flex items-center space-x-2 bg-green-50 px-3 py-2 rounded-full">
                                <div class="w-3 h-3 bg-green-500 rounded-full pulse-animation"></div>
                                <span class="text-xs sm:text-sm font-medium text-green-700">Live Update</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        <div class="group bg-gradient-to-br from-blue-500 to-blue-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-blue-100 font-medium mb-1 text-sm sm:text-base truncate">Kartu Keluarga</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="kk">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-blue-100">+12% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-users text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-emerald-500 to-emerald-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-emerald-100 font-medium mb-1 text-sm sm:text-base truncate">KTP Elektronik</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="ktp">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-emerald-100">+8% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-id-card text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-amber-500 to-amber-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-amber-100 font-medium mb-1 text-sm sm:text-base truncate">Kartu Identitas Anak</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="kia">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-amber-100">+15% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-child text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-indigo-500 to-indigo-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-indigo-100 font-medium mb-1 text-sm sm:text-base truncate">SKPWNI</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="skpwni">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-indigo-100">+5% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-passport text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-pink-500 to-pink-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105 sm:col-span-2 lg:col-span-1">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-pink-100 font-medium mb-1 text-sm sm:text-base truncate">SKDWNI</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="skdwni">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-pink-100">+3% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-globe text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dokumen Pencatatan Sipil -->
                <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 lg:p-8 border border-gray-100">
                    <div class="mb-6 sm:mb-8">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">Dokumen Pencatatan Sipil</h2>
                        <p class="text-sm sm:text-base text-gray-600">Monitoring pencatatan peristiwa penting kependudukan</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                        <div class="group bg-gradient-to-br from-teal-500 to-teal-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-teal-100 font-medium mb-1 text-sm sm:text-base truncate">Akta Kelahiran</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="aktaLahir">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-teal-100">+18% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-baby text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-red-500 to-red-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-red-100 font-medium mb-1 text-sm sm:text-base truncate">Akta Kematian</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="aktaMati">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-minus text-xs mr-1"></i>
                                        <span class="text-xs text-red-100">-2% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-cross text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-rose-500 to-rose-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-rose-100 font-medium mb-1 text-sm sm:text-base truncate">Akta Perkawinan</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="aktaKawin">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-up text-xs mr-1"></i>
                                        <span class="text-xs text-rose-100">+25% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-heart text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-slate-500 to-slate-600 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-white card-hover transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-slate-100 font-medium mb-1 text-sm sm:text-base truncate">Akta Perceraian</p>
                                    <p class="text-2xl sm:text-3xl font-bold" id="aktaCerai">0</p>
                                    <div class="flex items-center mt-2">
                                        <i class="fas fa-arrow-down text-xs mr-1"></i>
                                        <span class="text-xs text-slate-100">-5% dari kemarin</span>
                                    </div>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 sm:p-4 rounded-lg sm:rounded-xl flex-shrink-0 ml-3">
                                    <i class="fas fa-broken-heart text-lg sm:text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="xl:col-span-1 space-y-4 sm:space-y-6">
                <!-- Status Blangko -->
                <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 border border-gray-100">
                    <div class="mb-4 sm:mb-6">
                        <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2">Status Ketersediaan Blangko</h3>
                        <p class="text-xs sm:text-sm text-gray-600">Monitoring stok blangko KTP-el</p>
                    </div>
                    
                    <div class="space-y-4 sm:space-y-6">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-3 sm:p-4 rounded-lg sm:rounded-xl border border-green-200">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-2 sm:space-x-3">
                                    <div class="w-3 h-3 sm:w-4 sm:h-4 bg-green-500 rounded-full"></div>
                                    <span class="font-semibold text-gray-800 text-sm sm:text-base">KTP Elektronik</span>
                                </div>
                                <span class="font-bold text-green-700 text-base sm:text-lg" id="blangkoKTP">5,240</span>
                            </div>
                            <div class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full inline-block">
                                <i class="fas fa-check-circle mr-1"></i>
                                Stok Aman
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 sm:p-4 rounded-lg sm:rounded-xl">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xs sm:text-sm font-semibold text-gray-700">Penggunaan Hari Ini</span>
                                <span class="text-base sm:text-lg font-bold text-gray-800" id="penggunaanHariIni">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 sm:h-3 mb-2">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 sm:h-3 rounded-full transition-all duration-500 shadow-sm" id="progressBar" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span class="font-medium">Target: 200/hari</span>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Modal Login Protection -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-4 sm:p-6 lg:p-8">
                <div class="text-center mb-4 sm:mb-6">
                    <div class="bg-blue-100 w-12 h-12 sm:w-16 sm:h-16 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                        <i class="fas fa-lock text-blue-600 text-lg sm:text-2xl"></i>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">Akses Terbatas</h2>
                    <p class="text-sm sm:text-base text-gray-600">Masukkan username dan password untuk mengakses form input progres</p>
                </div>

                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user text-blue-600 mr-2"></i>Username
                        </label>
                        <input type="text" id="loginUsername" required 
                            class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Masukkan username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-key text-blue-600 mr-2"></i>Password
                        </label>
                        <div class="relative">
                            <input type="password" id="loginPassword" required 
                                class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-12"
                                placeholder="Masukkan password">
                            <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Username atau password salah. Silakan coba lagi.
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancelLogin" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                            Batal
                        </button>
                        <button type="submit" id="submitLogin" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Masuk</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Input Progres -->
    <div id="inputModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-4">
            <div class="p-4 sm:p-6 lg:p-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Input Progres Harian</h2>
                        <p class="text-gray-600 mt-1">Masukkan data progres dokumen hari ini</p>
                    </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <form id="progressForm" class="space-y-6">
                    <!-- Tanggal -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>Tanggal
                            </label>
                            <input type="date" id="inputTanggal" required 
                                class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-warehouse text-orange-600 mr-2"></i>Ketersediaan Blangko KTP-el
                            </label>
                            <input type="number" id="inputBlangko" min="0" required 
                                class="w-full border border-gray-300 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                placeholder="Masukkan jumlah stok blangko">
                        </div>
                    </div>

                    <!-- Dokumen Kependudukan -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-id-card text-green-600 mr-2"></i>
                            Dokumen Kependudukan
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kartu Keluarga</label>
                                <input type="number" id="inputKK" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">KTP Elektronik</label>
                                <input type="number" id="inputKTP" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kartu Identitas Anak</label>
                                <input type="number" id="inputKIA" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SKPWNI</label>
                                <input type="number" id="inputSKPWNI" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SKDWNI</label>
                                <input type="number" id="inputSKDWNI" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- Dokumen Pencatatan Sipil -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-certificate text-purple-600 mr-2"></i>
                            Dokumen Pencatatan Sipil
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Akta Kelahiran</label>
                                <input type="number" id="inputAktaLahir" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Akta Kematian</label>
                                <input type="number" id="inputAktaMati" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Akta Perkawinan</label>
                                <input type="number" id="inputAktaKawin" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-rose-500"
                                    placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Akta Perceraian</label>
                                <input type="number" id="inputAktaCerai" min="0" required 
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-slate-500"
                                    placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- Tombol Submit -->
                    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                        <button type="button" id="cancelForm" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
                            Batal
                        </button>
                        <button type="submit" id="submitForm" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span>Simpan Data</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <script>
        // Data dari Google Sheets
        let allData = [];
        let filteredData = [];
        let currentData = {
            kk: 0,
            ktp: 0,
            kia: 0,
            skpwni: 0,
            skdwni: 0,
            aktaLahir: 0,
            aktaMati: 0,
            aktaKawin: 0,
            aktaCerai: 0,
            blangkoKTP: 0
        };



        // URL Google Sheets CSV dengan cache busting
        const SHEET_URL_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRNXXv7oVIxIqloazDDhzaX6nFHnmxufaHxjDUuhqL724aAZGmgEZi_IhX_rL8ZpWAbYTDgBo0mqCn6/pub?gid=0&single=true&output=csv';
        
        function getSheetURL() {
            const timestamp = new Date().getTime();
            return `${SHEET_URL_BASE}&cachebust=${timestamp}`;
        }

        // Fungsi untuk mengambil data dari Google Sheets dengan multiple fallback methods
        async function fetchDataFromSheets() {
            try {
                showNotification('Mengambil data terbaru...', 'info');
                
                // Method 1: Direct fetch dengan CORS proxy
                let csvText = await tryFetchMethod1();
                
                if (!csvText) {
                    // Method 2: Fetch tanpa headers khusus
                    csvText = await tryFetchMethod2();
                }
                
                if (!csvText) {
                    // Method 3: Menggunakan JSONP approach
                    csvText = await tryFetchMethod3();
                }
                
                if (!csvText) {
                    throw new Error('Semua metode pengambilan data gagal. Periksa koneksi internet atau URL spreadsheet.');
                }
                
                console.log('CSV Response length:', csvText.length);
                
                // Parse CSV dengan handling yang lebih robust
                const rows = csvText.split('\n').filter(row => row.trim());
                
                if (rows.length < 2) {
                    throw new Error('Data tidak mencukupi. Pastikan spreadsheet memiliki header dan minimal 1 baris data.');
                }
                
                // Parse header dengan normalisasi
                const headers = rows[0].split(',').map(h => {
                    return h.trim().toLowerCase()
                        .replace(/"/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();
                });
                
                console.log('Headers found:', headers);
                
                // Expected column mapping - sesuai dengan struktur spreadsheet
                const expectedColumns = {
                    'tanggal': 'tanggal',
                    'kartu keluarga': 'kartu keluarga',
                    'ktp elektronik': 'ktp elektronik', 
                    'kartu identitas anak': 'kartu identitas anak',
                    'skpwni': 'skpwni',
                    'skdwni': 'skdwni',
                    'akta kelahiran': 'akta kelahiran',
                    'akta kematian': 'akta kematian',
                    'akta perkawinan': 'akta perkawinan',
                    'akta perceraian': 'akta perceraian',
                    'ketersediaan blangko ktp el': 'ketersediaan blangko ktp el'
                };
                
                allData = [];
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim()) {
                        // Handle CSV dengan quotes
                        const values = parseCSVRow(rows[i]);
                        const rowData = {};
                        
                        headers.forEach((header, index) => {
                            let value = values[index] ? values[index].trim().replace(/"/g, '') : '';
                            
                            // Parse tanggal dengan berbagai format
                            if (header === 'tanggal' || header.includes('tanggal') || header.includes('date')) {
                                if (value) {
                                    // Try different date formats
                                    let date = new Date(value);
                                    if (isNaN(date.getTime())) {
                                        // Try DD/MM/YYYY format
                                        const parts = value.split('/');
                                        if (parts.length === 3) {
                                            date = new Date(parts[2], parts[1] - 1, parts[0]);
                                        }
                                        // Try DD-MM-YYYY format
                                        if (isNaN(date.getTime())) {
                                            const parts2 = value.split('-');
                                            if (parts2.length === 3 && parts2[2].length === 4) {
                                                date = new Date(parts2[2], parts2[1] - 1, parts2[0]);
                                            } else if (parts2.length === 3 && parts2[0].length === 4) {
                                                date = new Date(parts2[0], parts2[1] - 1, parts2[2]);
                                            }
                                        }
                                    }
                                    rowData.tanggal = isNaN(date.getTime()) ? new Date() : date;
                                } else {
                                    rowData.tanggal = new Date();
                                }
                            } else {
                                // Parse angka dengan handling yang lebih baik
                                const cleanValue = value.replace(/[^\d.-]/g, '');
                                const numValue = parseFloat(cleanValue);
                                rowData[header] = isNaN(numValue) ? 0 : Math.max(0, Math.floor(numValue));
                            }
                        });
                        
                        // Validasi data sebelum menambahkan
                        if (rowData.tanggal && !isNaN(rowData.tanggal.getTime())) {
                            // Pastikan semua field numerik ada
                            const requiredFields = ['kartu keluarga', 'ktp elektronik', 'kartu identitas anak', 'skpwni', 'skdwni', 'akta kelahiran', 'akta kematian', 'akta perkawinan', 'akta perceraian', 'ketersediaan blangko ktp el'];
                            
                            // Set default 0 untuk field yang tidak ada
                            requiredFields.forEach(field => {
                                if (!(field in rowData)) {
                                    rowData[field] = 0;
                                }
                            });
                            
                            allData.push(rowData);
                        }
                    }
                }
                
                console.log('Parsed data count:', allData.length);
                
                if (allData.length === 0) {
                    throw new Error('Tidak ada data valid ditemukan. Periksa format CSV dan nama kolom.');
                }
                
                // Sort by date (newest first)
                allData.sort((a, b) => b.tanggal - a.tanggal);
                
                // Update date filter options
                updateDateFilterOptions();
                
                // Apply current filter
                applyDateFilter();
                
                updateConnectionStatus('connected');
                showNotification(`Data berhasil diperbarui! ${allData.length} record ditemukan.`, 'success');
                
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus('error', error.message);
                showNotification(`Gagal mengambil data: ${error.message}. Menggunakan data sample.`, 'error');
                
                // Fallback to sample data
                generateSampleData();
            }
        }

        // Method 1: Standard fetch dengan timeout
        async function tryFetchMethod1() {
            try {
                console.log('Trying Method 1: Standard fetch...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const SHEET_URL = getSheetURL();
                const response = await fetch(SHEET_URL, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                if (text && text.trim().length > 0) {
                    console.log('Method 1 successful');
                    return text;
                }
                throw new Error('Empty response');
                
            } catch (error) {
                console.log('Method 1 failed:', error.message);
                return null;
            }
        }

        // Method 2: Simple fetch tanpa headers khusus
        async function tryFetchMethod2() {
            try {
                console.log('Trying Method 2: Simple fetch...');
                const SHEET_URL = SHEET_URL_BASE + '&t=' + Date.now();
                
                const response = await fetch(SHEET_URL, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                if (text && text.trim().length > 0) {
                    console.log('Method 2 successful');
                    return text;
                }
                throw new Error('Empty response');
                
            } catch (error) {
                console.log('Method 2 failed:', error.message);
                return null;
            }
        }

        // Method 3: Menggunakan proxy atau alternative approach
        async function tryFetchMethod3() {
            try {
                console.log('Trying Method 3: Alternative approach...');
                
                // Coba dengan URL yang sedikit berbeda
                const alternativeUrl = SHEET_URL_BASE.replace('/pub?', '/export?') + '&format=csv&t=' + Date.now();
                
                const response = await fetch(alternativeUrl, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                if (text && text.trim().length > 0) {
                    console.log('Method 3 successful');
                    return text;
                }
                throw new Error('Empty response');
                
            } catch (error) {
                console.log('Method 3 failed:', error.message);
                return null;
            }
        }

        // Fungsi helper untuk parse CSV row dengan handling quotes
        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Fungsi untuk generate sample data jika gagal fetch
        function generateSampleData() {
            console.log('Generating sample data...');
            const today = new Date();
            allData = [];
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                allData.push({
                    tanggal: date,
                    'kartu keluarga': Math.floor(Math.random() * 25) + 35,
                    'ktp elektronik': Math.floor(Math.random() * 50) + 80,
                    'kartu identitas anak': Math.floor(Math.random() * 20) + 15,
                    'skpwni': Math.floor(Math.random() * 10) + 5,
                    'skdwni': Math.floor(Math.random() * 8) + 3,
                    'akta kelahiran': Math.floor(Math.random() * 30) + 40,
                    'akta kematian': Math.floor(Math.random() * 15) + 8,
                    'akta perkawinan': Math.floor(Math.random() * 20) + 15,
                    'akta perceraian': Math.floor(Math.random() * 8) + 3,
                    'ketersediaan blangko ktp el': 5240 - (i * 5)
                });
            }
            
            console.log('Sample data generated:', allData.length, 'records');
            updateDateFilterOptions();
            applyDateFilter();
        }

        // Fungsi untuk update date filter options
        function updateDateFilterOptions() {
            const dateFilter = document.getElementById('dateFilter');
            const currentValue = dateFilter.value;
            
            // Keep existing options, just update data count
            document.getElementById('dataCount').textContent = allData.length;
        }

        // Fungsi untuk apply date filter
        function applyDateFilter() {
            const filterValue = document.getElementById('dateFilter').value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let startDate, endDate;
            
            switch (filterValue) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'yesterday':
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 1);
                    endDate = new Date(startDate);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 7);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 30);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'custom':
                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    if (startInput && endInput) {
                        startDate = new Date(startInput);
                        endDate = new Date(endInput);
                        endDate.setHours(23, 59, 59, 999);
                    } else {
                        return;
                    }
                    break;
                default:
                    startDate = new Date(today);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
            }
            
            // Filter data berdasarkan tanggal
            filteredData = allData.filter(item => {
                const itemDate = new Date(item.tanggal);
                return itemDate >= startDate && itemDate <= endDate;
            });
            
            // Aggregate data
            aggregateData();
            updateDisplay();
        }

        // Fungsi untuk aggregate data
        function aggregateData() {
            if (filteredData.length === 0) {
                // Reset to zero if no data
                currentData = {
                    kk: 0,
                    ktp: 0,
                    kia: 0,
                    skpwni: 0,
                    skdwni: 0,
                    aktaLahir: 0,
                    aktaMati: 0,
                    aktaKawin: 0,
                    aktaCerai: 0,
                    blangkoKTP: 0
                };
                return;
            }
            
            // Sum all filtered data using correct column names
            currentData = {
                kk: filteredData.reduce((sum, item) => sum + (item['kartu keluarga'] || 0), 0),
                ktp: filteredData.reduce((sum, item) => sum + (item['ktp elektronik'] || 0), 0),
                kia: filteredData.reduce((sum, item) => sum + (item['kartu identitas anak'] || 0), 0),
                skpwni: filteredData.reduce((sum, item) => sum + (item['skpwni'] || 0), 0),
                skdwni: filteredData.reduce((sum, item) => sum + (item['skdwni'] || 0), 0),
                aktaLahir: filteredData.reduce((sum, item) => sum + (item['akta kelahiran'] || 0), 0),
                aktaMati: filteredData.reduce((sum, item) => sum + (item['akta kematian'] || 0), 0),
                aktaKawin: filteredData.reduce((sum, item) => sum + (item['akta perkawinan'] || 0), 0),
                aktaCerai: filteredData.reduce((sum, item) => sum + (item['akta perceraian'] || 0), 0),
                blangkoKTP: filteredData.length > 0 ? (filteredData[0]['ketersediaan blangko ktp el'] || 0) : 0
            };
        }

        // Fungsi update display dengan null checks
        function updateDisplay() {
            // Helper function untuk update element dengan null check
            function safeUpdateElement(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`Element with id '${id}' not found`);
                }
            }

            // Update tampilan dengan null checks
            safeUpdateElement('kk', currentData.kk);
            safeUpdateElement('ktp', currentData.ktp);
            safeUpdateElement('kia', currentData.kia);
            safeUpdateElement('skpwni', currentData.skpwni);
            safeUpdateElement('skdwni', currentData.skdwni);
            safeUpdateElement('aktaLahir', currentData.aktaLahir);
            safeUpdateElement('aktaMati', currentData.aktaMati);
            safeUpdateElement('aktaKawin', currentData.aktaKawin);
            safeUpdateElement('aktaCerai', currentData.aktaCerai);
            safeUpdateElement('blangkoKTP', currentData.blangkoKTP.toLocaleString());
            safeUpdateElement('stokBlangko', currentData.blangkoKTP.toLocaleString());

            // Update summary cards
            const totalKependudukan = currentData.kk + currentData.ktp + currentData.kia + currentData.skpwni + currentData.skdwni;
            const totalSipil = currentData.aktaLahir + currentData.aktaMati + currentData.aktaKawin + currentData.aktaCerai;
            const totalToday = totalKependudukan + totalSipil;

            safeUpdateElement('totalKependudukan', totalKependudukan);
            safeUpdateElement('totalSipil', totalSipil);
            safeUpdateElement('totalToday', totalToday);

            // Update progress bar dengan null check
            const penggunaan = currentData.ktp;
            const target = 200;
            const percentage = Math.min((penggunaan / target) * 100, 100);
            
            safeUpdateElement('penggunaanHariIni', penggunaan);
            
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }

            // Update data count
            safeUpdateElement('dataCount', allData.length);

            console.log('Display updated successfully:', currentData);
        }

        // Fungsi animasi hover untuk cards
        function addCardAnimations() {
            const cards = document.querySelectorAll('.group');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05) translateY(-5px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) translateY(0)';
                });
            });
        }

        // Event listener untuk filter kategori
        const filterButtons = {
            filterAll: 'all',
            filterKependudukan: 'kependudukan',
            filterSipil: 'sipil'
        };

        Object.keys(filterButtons).forEach(buttonId => {
            document.getElementById(buttonId).addEventListener('click', function() {
                // Update button states
                Object.keys(filterButtons).forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                
                this.classList.remove('bg-gray-200', 'text-gray-700');
                this.classList.add('bg-blue-600', 'text-white');

                // Apply filter
                applyFilter(filterButtons[buttonId]);
            });
        });

        // Fungsi apply filter
        function applyFilter(filterType) {
            const kependudukanCards = document.querySelectorAll('#kk, #ktp, #kia, #skpwni, #skdwni').map(el => el.closest('.bg-gradient-to-r').parentElement);
            const sipilCards = document.querySelectorAll('#aktaLahir, #aktaMati, #aktaKawin, #aktaCerai').map(el => el.closest('.bg-gradient-to-r').parentElement);
            
            const kependudukanSection = document.querySelector('.bg-white.rounded-xl.shadow-md.p-6.mb-8');
            const sipilSection = document.querySelector('.bg-white.rounded-xl.shadow-md.p-6:not(.mb-8)');

            if (filterType === 'all') {
                kependudukanSection.style.display = 'block';
                sipilSection.style.display = 'block';
            } else if (filterType === 'kependudukan') {
                kependudukanSection.style.display = 'block';
                sipilSection.style.display = 'none';
            } else if (filterType === 'sipil') {
                kependudukanSection.style.display = 'none';
                sipilSection.style.display = 'block';
            }
        }

        // Event listener untuk date filter
        document.getElementById('dateFilter').addEventListener('change', function(e) {
            const value = e.target.value;
            const customRange = document.getElementById('customDateRange');
            
            if (value === 'custom') {
                customRange.classList.remove('hidden');
                // Set default dates
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
                document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
            } else {
                customRange.classList.add('hidden');
                applyDateFilter();
            }
        });

        // Event listener untuk custom date range
        document.getElementById('startDate').addEventListener('change', applyDateFilter);
        document.getElementById('endDate').addEventListener('change', applyDateFilter);

        // Event listener untuk refresh data dengan retry mechanism
        document.getElementById('refreshData').addEventListener('click', async function() {
            const icon = this.querySelector('i');
            const button = this;
            
            icon.classList.add('fa-spin');
            button.disabled = true;
            
            try {
                await fetchDataFromSheets();
            } catch (error) {
                console.error('Refresh failed:', error);
                showNotification('Gagal refresh data. Coba lagi dalam beberapa saat.', 'error');
            } finally {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    button.disabled = false;
                }, 1000);
            }
        });

        // Fungsi untuk cek koneksi internet
        async function checkInternetConnection() {
            try {
                // Coba ping ke Google DNS
                const response = await fetch('https://dns.google/resolve?name=google.com&type=A', {
                    method: 'GET',
                    mode: 'cors',
                    signal: AbortSignal.timeout(5000)
                });
                return response.ok;
            } catch (error) {
                console.log('Internet connection check failed:', error.message);
                return false;
            }
        }

        // Fungsi untuk validasi URL Google Sheets
        function validateGoogleSheetsURL(url) {
            const patterns = [
                /docs\.google\.com\/spreadsheets/,
                /\/pub\?/,
                /output=csv/
            ];
            
            return patterns.every(pattern => pattern.test(url));
        }

        // Fungsi retry dengan exponential backoff dan connection check
        async function fetchWithRetry(url, options, maxRetries = 3) {
            // Validasi URL terlebih dahulu
            if (!validateGoogleSheetsURL(url)) {
                throw new Error('URL Google Sheets tidak valid. Pastikan format URL benar.');
            }

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Cek koneksi internet sebelum retry
                    if (i > 0) {
                        const hasInternet = await checkInternetConnection();
                        if (!hasInternet) {
                            throw new Error('Tidak ada koneksi internet. Periksa koneksi Anda.');
                        }
                    }

                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                } catch (error) {
                    console.log(`Attempt ${i + 1} failed:`, error.message);
                    
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    
                    // Wait before retry (exponential backoff)
                    const delay = Math.pow(2, i) * 1000;
                    showNotification(`Mencoba ulang dalam ${delay/1000} detik... (${i + 1}/${maxRetries})`, 'info');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // Event listener untuk export data
        document.getElementById('exportData').addEventListener('click', function() {
            exportToCSV();
        });

        // Event listener untuk input progress
        document.getElementById('inputProgress').addEventListener('click', function() {
            openLoginModal();
        });

        // Event listeners untuk login modal
        document.getElementById('cancelLogin').addEventListener('click', closeLoginModal);
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
        
        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('loginPassword');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Close login modal when clicking outside
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLoginModal();
            }
        });

        // Event listeners untuk modal
        document.getElementById('closeModal').addEventListener('click', closeInputModal);
        document.getElementById('cancelForm').addEventListener('click', closeInputModal);
        
        // Close modal when clicking outside
        document.getElementById('inputModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInputModal();
            }
        });

        // Form submission
        document.getElementById('progressForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitProgressData();
        });

        // Fungsi export to Google Sheets Database
        function exportToCSV() {
            showNotification('Membuka database Google Sheets...', 'info');
            
            // Buka Google Sheets database di tab baru
            const sheetsUrl = 'https://docs.google.com/spreadsheets/d/1hRAsKF_2XSrMwsnJevPJyFMBqleOwNdFgmQwFYpqQ_o/edit?usp=sharing';
            window.open(sheetsUrl, '_blank', 'noopener,noreferrer');
            
            showNotification('Database Google Sheets berhasil dibuka!', 'success');
        }

        // URL untuk mengirim data ke Google Sheets
        const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycby8fer-K-ZYt0YcJr1uzG6qAQ7a_AvGHfO5kFRgQ1ahWIxiUDp4tb81mh7j9gbu04U3/exec';

        // Kredensial login
        const LOGIN_CREDENTIALS = {
            username: 'dukcapiltanimbar',
            password: '12345678'
        };

        // Fungsi untuk membuka modal login
        function openLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.remove('hidden');
            
            // Reset form login
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
            
            // Focus ke username input
            setTimeout(() => {
                document.getElementById('loginUsername').focus();
            }, 100);
        }

        // Fungsi untuk menutup modal login
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        // Fungsi untuk handle login
        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            // Validasi kredensial
            if (username === LOGIN_CREDENTIALS.username && password === LOGIN_CREDENTIALS.password) {
                // Login berhasil
                closeLoginModal();
                showNotification('Login berhasil! Membuka form input progres...', 'success');
                
                // Buka modal input progres setelah delay singkat
                setTimeout(() => {
                    openInputModal();
                }, 500);
            } else {
                // Login gagal
                errorDiv.classList.remove('hidden');
                
                // Shake animation untuk form
                const form = document.getElementById('loginForm');
                form.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    form.style.animation = '';
                }, 500);
                
                // Clear password field
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        // Fungsi untuk membuka modal input
        function openInputModal() {
            const modal = document.getElementById('inputModal');
            modal.classList.remove('hidden');
            
            // Set tanggal hari ini sebagai default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputTanggal').value = today;
            
            // Reset form
            document.getElementById('progressForm').reset();
            document.getElementById('inputTanggal').value = today;
        }

        // Fungsi untuk menutup modal input
        function closeInputModal() {
            const modal = document.getElementById('inputModal');
            modal.classList.add('hidden');
            document.getElementById('progressForm').reset();
        }

        // Fungsi untuk submit data progres
        async function submitProgressData() {
            const submitButton = document.getElementById('submitForm');
            const originalText = submitButton.innerHTML;
            
            // Disable button dan show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
            
            try {
                // Ambil data dari form
                const formData = {
                    tanggal: document.getElementById('inputTanggal').value,
                    kartuKeluarga: parseInt(document.getElementById('inputKK').value) || 0,
                    ktpElektronik: parseInt(document.getElementById('inputKTP').value) || 0,
                    kartuIdentitasAnak: parseInt(document.getElementById('inputKIA').value) || 0,
                    skpwni: parseInt(document.getElementById('inputSKPWNI').value) || 0,
                    skdwni: parseInt(document.getElementById('inputSKDWNI').value) || 0,
                    aktaKelahiran: parseInt(document.getElementById('inputAktaLahir').value) || 0,
                    aktaKematian: parseInt(document.getElementById('inputAktaMati').value) || 0,
                    aktaPerkawinan: parseInt(document.getElementById('inputAktaKawin').value) || 0,
                    aktaPerceraian: parseInt(document.getElementById('inputAktaCerai').value) || 0,
                    ketersediaanBlangkoKtpEl: parseInt(document.getElementById('inputBlangko').value) || 0
                };

                // Kirim data ke Google Sheets
                const response = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                // Karena mode no-cors, kita tidak bisa membaca response
                // Jadi kita asumsikan berhasil jika tidak ada error
                showNotification('Data berhasil disimpan ke Google Sheets!', 'success');
                closeInputModal();
                
                // Refresh data setelah 2 detik
                setTimeout(() => {
                    fetchDataFromSheets();
                }, 2000);
                
            } catch (error) {
                console.error('Error submitting data:', error);
                showNotification('Gagal menyimpan data. Silakan coba lagi.', 'error');
            } finally {
                // Restore button
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }

        // Fungsi show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'info' ? 'bg-blue-500 text-white' : 
                'bg-red-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'info' ? 'fa-info-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Status koneksi
        let connectionStatus = 'connecting';
        let lastSuccessfulFetch = null;

        function updateConnectionStatus(status, message = '') {
            try {
                connectionStatus = status;
                const statusElement = document.querySelector('.pulse-animation');
                
                if (!statusElement) {
                    console.warn('Status element not found, skipping status update');
                    return;
                }
                
                const statusContainer = statusElement.parentElement;
                const statusText = statusContainer.querySelector('span');
                const statusDot = statusContainer.querySelector('.pulse-animation, .w-3');
                
                if (!statusText || !statusDot) {
                    console.warn('Status text or dot element not found');
                    return;
                }
                
                switch (status) {
                    case 'connected':
                        statusDot.className = 'w-3 h-3 bg-green-500 rounded-full pulse-animation';
                        statusText.textContent = 'Terhubung ke Google Sheets';
                        statusText.className = 'text-xs sm:text-sm font-medium text-green-700';
                        lastSuccessfulFetch = new Date();
                        break;
                    case 'error':
                        statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                        statusText.textContent = `Error: ${message}`;
                        statusText.className = 'text-xs sm:text-sm font-medium text-red-700';
                        break;
                    case 'connecting':
                        statusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full pulse-animation';
                        statusText.textContent = 'Menghubungkan ke Google Sheets...';
                        statusText.className = 'text-xs sm:text-sm font-medium text-yellow-700';
                        break;
                }
            } catch (error) {
                console.error('Error updating connection status:', error);
            }
        }

        // Fungsi diagnostik untuk troubleshooting
        async function runDiagnostics() {
            console.log('=== DIAGNOSTIK SISTEM ===');
            
            // 1. Cek koneksi internet
            console.log('1. Mengecek koneksi internet...');
            const hasInternet = await checkInternetConnection();
            console.log('   Koneksi internet:', hasInternet ? '✅ OK' : '❌ GAGAL');
            
            // 2. Cek URL Google Sheets
            console.log('2. Mengecek URL Google Sheets...');
            const isValidURL = validateGoogleSheetsURL(SHEET_URL_BASE);
            console.log('   URL valid:', isValidURL ? '✅ OK' : '❌ GAGAL');
            console.log('   URL:', SHEET_URL_BASE);
            
            // 3. Test fetch ke Google Sheets
            console.log('3. Testing akses ke Google Sheets...');
            try {
                const testResponse = await fetch(SHEET_URL_BASE + '&t=' + Date.now(), {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                console.log('   Test fetch: ✅ OK');
            } catch (error) {
                console.log('   Test fetch: ❌ GAGAL -', error.message);
            }
            
            // 4. Cek CORS policy
            console.log('4. Mengecek CORS policy...');
            try {
                const corsTest = await fetch(SHEET_URL_BASE, { method: 'GET', mode: 'cors' });
                console.log('   CORS: ✅ OK');
            } catch (error) {
                console.log('   CORS: ⚠️ TERBATAS -', error.message);
            }
            
            console.log('=== SELESAI DIAGNOSTIK ===');
            
            return {
                internet: hasInternet,
                validURL: isValidURL,
                timestamp: new Date().toISOString()
            };
        }

        // Inisialisasi aplikasi dengan diagnostik
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                updateConnectionStatus('connecting');
                
                // Jalankan diagnostik
                const diagnostics = await runDiagnostics();
                
                // Load data pertama kali
                try {
                    await fetchDataFromSheets();
                } catch (error) {
                    console.error('Initial data fetch failed:', error);
                    
                    // Tampilkan pesan troubleshooting yang lebih detail
                    if (!diagnostics.internet) {
                        showNotification('Tidak ada koneksi internet. Periksa koneksi Anda dan coba lagi.', 'error');
                    } else if (!diagnostics.validURL) {
                        showNotification('URL Google Sheets tidak valid. Hubungi administrator.', 'error');
                    } else {
                        showNotification('Gagal mengambil data. Menggunakan data sample untuk demo.', 'error');
                    }
                }
                
                addCardAnimations();
                
                // Auto refresh setiap 30 detik dengan error handling yang lebih baik
                setInterval(async () => {
                    try {
                        await fetchDataFromSheets();
                    } catch (error) {
                        console.error('Auto refresh failed:', error);
                        // Jangan tampilkan notifikasi error untuk auto refresh
                        // Hanya log ke console
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Application initialization failed:', error);
                showNotification('Gagal menginisialisasi aplikasi. Refresh halaman untuk mencoba lagi.', 'error');
            }
        });

        // Load data immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            // DOM is still loading
        } else {
            // DOM is already loaded
            (async () => {
                updateConnectionStatus('connecting');
                const diagnostics = await runDiagnostics();
                
                try {
                    await fetchDataFromSheets();
                } catch (error) {
                    console.error('Initial data fetch failed:', error);
                    if (!diagnostics.internet) {
                        showNotification('Tidak ada koneksi internet. Periksa koneksi Anda dan coba lagi.', 'error');
                    } else {
                        showNotification('Gagal mengambil data. Menggunakan data sample untuk demo.', 'error');
                    }
                }
                
                addCardAnimations();
            })();
        }

        // Tambahkan event listener untuk debugging (Ctrl+Shift+D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                runDiagnostics();
                showNotification('Diagnostik dijalankan. Lihat console untuk detail.', 'info');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'985006dd24c15f65',t:'MTc1ODg2MTAzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
